---
- name: Deploy BIOP Desktop with Jupyter and VNC
  hosts: localhost
  gather_facts: false
  become: yes
  
  vars:
    biop_image: "biop/biop-desktop:0.2.4"
    biop_port: 8888
    nginx_app_dir: "/etc/nginx/app-location-conf.d"
    data_dir: "/data/biop"
    
  tasks:
    - name: Create BIOP data directory
      file:
        path: "{{ data_dir }}"
        state: directory
        mode: '0777'

    - name: Pull BIOP Docker image
      docker_image:
        name: "{{ biop_image }}"
        source: pull

    - name: Run BIOP container
      docker_container:
        name: biop-desktop
        image: "{{ biop_image }}"
        state: started
        restart_policy: unless-stopped
        ports:
          - "127.0.0.1:{{ biop_port }}:8888"
        volumes:
          - "{{ data_dir }}:/home/biop:rw"
        shm_size: 2g
        env:
          JUPYTER_ENABLE_LAB: "yes"

    - name: Wait for BIOP container to be ready
      wait_for:
        host: 127.0.0.1
        port: "{{ biop_port }}"
        delay: 5
        timeout: 60

    - name: Create Nginx app configuration directory
      file:
        path: "{{ nginx_app_dir }}"
        state: directory
        mode: '0755'

    - name: Configure Nginx proxy for BIOP with SRAM authentication
      lineinfile:
        path: "{{ nginx_app_dir }}/authentication.conf"
        line: |
          location /biop/ {
              error_page 401 = @custom_401;
              auth_request /validate;
              auth_request_set $username $upstream_http_username;
              proxy_set_header REMOTE_USER $username;
              proxy_pass http://127.0.0.1:{{ biop_port }}/;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection $connection_upgrade;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_set_header X-Forwarded-Prefix /biop;
              
              proxy_read_timeout 86400;
              proxy_send_timeout 86400;
              proxy_buffering off;
              client_max_body_size 10G;
          }

    - name: Restart nginx
      service:
        name: nginx
        state: restarted

    - name: Create usage instructions file
      copy:
        dest: "/tmp/BIOP_INSTRUCTIONS.txt"
        content: |
          BIOP Desktop Access
          ====================================
          
          Jupyter Lab: https://{{ workspace_fqdn }}/biop/lab
          VNC Desktop: https://{{ workspace_fqdn }}/biop/vnc
          
          Data directory: {{ data_dir }}
        mode: '0644'
